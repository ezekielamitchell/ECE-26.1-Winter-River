# Telegraf Configuration for MQTT to InfluxDB Bridge
# This file bridges MQTT messages to InfluxDB for Grafana visualization

# Global tags
[global_tags]
  project = "iot-mqtt"

# Agent configuration
[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = "0s"
  hostname = ""
  omit_hostname = false

# InfluxDB v2 Output Plugin
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "my-super-secret-auth-token"
  organization = "iot-project"
  bucket = "mqtt_metrics"

# MQTT Consumer Input Plugin
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_BROKER_HOST}:${MQTT_BROKER_PORT}"]

  # Topics to subscribe to
  topics = [
    "iot/node/+/telemetry",
    "iot/node/+/status",
    "iot/broker/#"
  ]

  # Client ID
  client_id = "telegraf-mqtt-consumer"

  # Data format
  data_format = "json"

  # JSON configuration
  json_string_fields = ["status", "node_id"]

  # Tag keys (for filtering in Grafana)
  tag_keys = ["node_id", "sensor_type"]

# TODO: Add authentication if MQTT broker requires it
# username = ""
# password = ""

# TODO: Configure additional input plugins for system metrics
# [[inputs.cpu]]
# [[inputs.mem]]
# [[inputs.disk]]

# TODO: Add MQTT broker statistics input (if mosquitto exposes them via $SYS topics)
# [[inputs.mqtt_consumer]]
#   servers = ["tcp://${MQTT_BROKER_HOST}:${MQTT_BROKER_PORT}"]
#   topics = ["$SYS/#"]
#   data_format = "value"
#   data_type = "float"
