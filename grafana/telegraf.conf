# Telegraf Configuration — Native systemd install
# MQTT Consumer → InfluxDB v2 bridge for Winter River
#
# Credentials are injected at setup time via /etc/default/telegraf.
# Re-run scripts/setup_pi.sh to update them.
#
# Topic schema: winter-river/<node_id>/status  (JSON payload)

[global_tags]
  project = "winter-river"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = "0s"
  omit_hostname = false

# ── Output: InfluxDB v2 ───────────────────────────────────────────────────────
[[outputs.influxdb_v2]]
  urls = ["http://localhost:8086"]
  # Token is sourced from /etc/default/telegraf (set by scripts/setup_pi.sh)
  token = "${INFLUX_TOKEN}"
  organization = "iot-project"
  bucket = "mqtt_metrics"

# ── Input: MQTT Consumer ──────────────────────────────────────────────────────
[[inputs.mqtt_consumer]]
  servers = ["tcp://192.168.4.1:1883"]

  # Subscribe to all Winter River node status messages
  # Topic format: winter-river/<node_id>/status
  topics = [
    "winter-river/#",
  ]

  client_id = "telegraf-winter-river"
  qos = 0

  # Use the MQTT topic as the measurement name (e.g. "winter-river/pdu_a/status")
  topic_tag = "topic"

  # Parse JSON payloads such as:
  #   {"node_id": "pdu_a", "voltage": 12.1, "current": 2.3, "status": "ok"}
  data_format = "json"

  # Promote string fields to tags so Grafana can filter by them
  tag_keys = ["node_id", "status", "type"]

  # String fields that should stay as strings (not converted to numbers)
  json_string_fields = ["node_id", "status", "type"]
